# ~~ Generated by projen. To modify, edit .projenrc.ts and run "pnpm dlx projen".

name: release
on:
  workflow_dispatch: {}
jobs:
  init:
    name: init
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      packages: read
    outputs:
      NX_BASE: ${{ steps.nx_base.outputs.NX_BASE }}
      AFFECTED_IMAGES: ${{ steps.affected.outputs.AFFECTED_IMAGES }}
      AFFECTED_PROJECTS: ${{ steps.affected.outputs.AFFECTED_PROJECTS }}
      PUBLISH_IMAGE: ${{ steps.publish.outputs.PUBLISH_IMAGE }}
    steps:
      - name: Clear cache
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |2-
            
                                    const caches = await github.rest.actions.getActionsCacheList({repo: context.repo.repo,owner: context.repo.owner})
                                    for (const cache of caches.data.actions_caches) {
                                    try {
                                        await github.rest.actions.deleteActionsCacheById({repo: context.repo.repo,owner: context.repo.owner,cache_id: cache.id})
                                        console.log('Successfully deleted cache with ID: ',cache.id);
                                    } catch (error) { 
                                        console.log('Error deleting cache with ID: ',cache.id, error);
                                    }
                                }
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.25.0
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: 24.9.0
          package-manager-cache: pnpm
      - name: Configure .npmrc
        run: export NODE_AUTH_TOKEN=$(echo ${{ secrets.ENCODED_TOKEN }} | base64 -d) && npm config delete resolution-mode && npm config set //npm.pkg.github.com/:_authToken $NODE_AUTH_TOKEN && npm config set @mwashburn160:registry https://npm.pkg.github.com/
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      - name: Set git user
        run: git config user.name "ci" && git config user.email "mwashburn160@gmail.com"
      - name: Prune tags older than 30 days
        run: CUTOFF_DATE=$(date -d "30 days ago" +%s) && git for-each-ref --format="%(refname:short) %(creatordate:unix)" refs/tags | while read TAG DATE; do if [ $DATE -lt $CUTOFF_DATE ]; then echo "Deleting tag $TAG created on $(date -d @$DATE)"; git tag -d $TAG; fi; done && git push origin --tags --prune
      - name: Derive SHAs for NX:BASE, NX:HEAD
        id: sha
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: main
      - name: Affected projects and images
        id: affected
        env:
          IMAGE_PROJECTS: '["frontend","platform","quota","pipeline","plugin"]'
        run: |-
          echo AFFECTED_PROJECTS=$(pnpm nx show projects --affected --json) >> $GITHUB_OUTPUT && echo AFFECTED_IMAGES=$(jq -n --arg LIST "$(comm -12 <(pnpm nx show projects --affected | sort) <(echo $IMAGE_PROJECTS | jq -r '.[]' | sort))" '$LIST | split("
          ") | map(select(length>0))') >> $GITHUB_OUTPUT
      - name: Affected details
        id: affected_details
        run: echo AFFECTED_PROJECTS=${{ steps.affected.outputs.AFFECTED_PROJECTS }} && echo AFFECTED_IMAGES=${{ steps.affected.outputs.AFFECTED_IMAGES }}
      - name: Exported NX:BASE
        id: nx_base
        run: echo NX_BASE=${{ env.NX_BASE }} >> $GITHUB_OUTPUT
      - name: Check publish images
        id: publish
        run: echo PUBLISH_IMAGE=$(pnpm nx show projects --affected --json | jq 'any(contains("frontend","platform","quota","pipeline","plugin"))') >> $GITHUB_OUTPUT
      - name: Publish details
        id: publish_details
        run: "echo PUBLISH_IMAGE: ${{ steps.publish.outputs.PUBLISH_IMAGE }}"
  build:
    name: build
    needs: init
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      packages: read
    if: ${{ needs.init.outputs.AFFECTED_PROJECTS != '[]' || needs.init.outputs.AFFECTED_IMAGES != '[]' }}
    steps:
      - name: Clear cache
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |2-
            
                                    const caches = await github.rest.actions.getActionsCacheList({repo: context.repo.repo,owner: context.repo.owner})
                                    for (const cache of caches.data.actions_caches) {
                                    try {
                                        await github.rest.actions.deleteActionsCacheById({repo: context.repo.repo,owner: context.repo.owner,cache_id: cache.id})
                                        console.log('Successfully deleted cache with ID: ',cache.id);
                                    } catch (error) { 
                                        console.log('Error deleting cache with ID: ',cache.id, error);
                                    }
                                }
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.25.0
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: 24.9.0
          package-manager-cache: pnpm
      - name: Configure .npmrc
        run: export NODE_AUTH_TOKEN=$(echo ${{ secrets.ENCODED_TOKEN }} | base64 -d) && npm config delete resolution-mode && npm config set //npm.pkg.github.com/:_authToken $NODE_AUTH_TOKEN && npm config set @mwashburn160:registry https://npm.pkg.github.com/
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      - name: Set git user
        run: git config user.name "ci" && git config user.email "mwashburn160@gmail.com"
      - name: Prune tags older than 30 days
        run: CUTOFF_DATE=$(date -d "30 days ago" +%s) && git for-each-ref --format="%(refname:short) %(creatordate:unix)" refs/tags | while read TAG DATE; do if [ $DATE -lt $CUTOFF_DATE ]; then echo "Deleting tag $TAG created on $(date -d @$DATE)"; git tag -d $TAG; fi; done && git push origin --tags --prune
      - name: Set NX:BASE, NX:HEAD
        id: set_nx_base
        run: echo NX_BASE=${{ needs.init.outputs.NX_BASE }} >> $GITHUB_ENV && echo NX_HEAD=$(git rev-parse HEAD) >> $GITHUB_ENV
      - name: Details NX_BASE, NX_HEAD
        id: details_nx_base
        run: 'echo "NX_BASE: ${{ env.NX_BASE }}, NX_HEAD: ${{ env.NX_HEAD }}"'
      - name: Run build target
        id: build_target
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: pnpm nx affected --target build --base ${{ env.NX_BASE }} --head ${{ env.NX_HEAD }} --verbose
      - name: Semantic version
        id: semantic_version
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: pnpm nx release --first-release --skip-publish --verbose
      - name: Check publish library
        id: check
        run: echo PUBLISH_LIB=$(pnpm nx show projects --affected --json | jq 'any(contains("api-core","api-server","pipeline-core","pipeline-data","pipeline-manager"))')  >> $GITHUB_OUTPUT
      - name: Publish library
        id: publish
        if: ${{ steps.check.outputs.PUBLISH_LIB == 'true' }}
        run: pnpm publish --access restricted --filter @mwashburn160/* --no-git-checks --verbose
      - name: Upload artifact
        id: upload_artifact
        uses: actions/upload-artifact@v6
        with:
          name: artifacts
          path: |-
            ./**/lib/
            ./**/dist/
            !./**/node_modules/
      - name: Push new tag to the repository
        id: push_changes
        run: git push --follow-tags
  publish:
    name: publish image
    needs:
      - init
      - build
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      packages: read
    if: ${{ needs.init.outputs.PUBLISH_IMAGE == 'true' }}
    steps:
      - name: Clear cache
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |2-
            
                                    const caches = await github.rest.actions.getActionsCacheList({repo: context.repo.repo,owner: context.repo.owner})
                                    for (const cache of caches.data.actions_caches) {
                                    try {
                                        await github.rest.actions.deleteActionsCacheById({repo: context.repo.repo,owner: context.repo.owner,cache_id: cache.id})
                                        console.log('Successfully deleted cache with ID: ',cache.id);
                                    } catch (error) { 
                                        console.log('Error deleting cache with ID: ',cache.id, error);
                                    }
                                }
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.25.0
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: 24.9.0
          package-manager-cache: pnpm
      - name: Configure .npmrc
        run: export NODE_AUTH_TOKEN=$(echo ${{ secrets.ENCODED_TOKEN }} | base64 -d) && npm config delete resolution-mode && npm config set //npm.pkg.github.com/:_authToken $NODE_AUTH_TOKEN && npm config set @mwashburn160:registry https://npm.pkg.github.com/
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
      - name: Set git user
        run: git config user.name "ci" && git config user.email "mwashburn160@gmail.com"
      - name: Prune tags older than 30 days
        run: CUTOFF_DATE=$(date -d "30 days ago" +%s) && git for-each-ref --format="%(refname:short) %(creatordate:unix)" refs/tags | while read TAG DATE; do if [ $DATE -lt $CUTOFF_DATE ]; then echo "Deleting tag $TAG created on $(date -d @$DATE)"; git tag -d $TAG; fi; done && git push origin --tags --prune
      - name: Download artifact
        id: dnload_artifact
        uses: actions/download-artifact@v7
        with:
          name: artifacts
          path: dnload
      - name: Copy artifacts to destination
        id: copy_artifact
        run: cp -rv dnload/* ./
      - name: Login into container registry
        id: login_registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_TOKEN }}
      - name: Setup buildx
        id: setup_buildx
        uses: docker/setup-buildx-action@v3
        with:
          cleanup: true
          cache-binary: false
      - name: Build docker image
        id: build
        env:
          PROJECT_NAME: ${{ matrix.project_name }}
        run: pnpm nx run ${PROJECT_NAME}:docker:build --verbose
      - name: Tag docker image
        id: tag
        env:
          REGISTRY: ghcr.io/mwashburn160
          PROJECT_NAME: ${{ matrix.project_name }}
        run: pnpm nx run ${PROJECT_NAME}:docker:tag --verbose
      - name: Push docker image
        id: push
        env:
          REGISTRY: ghcr.io/mwashburn160
          PROJECT_NAME: ${{ matrix.project_name }}
        run: pnpm nx run ${PROJECT_NAME}:docker:push --verbose
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        project_name: ${{ fromJson(needs.init.outputs.AFFECTED_IMAGES) }}
