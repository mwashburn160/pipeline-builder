# Load NJS Module
load_module modules/ngx_http_js_module.so;

# Environment Variables
env JWT_SECRET;

worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    multi_accept on;
}

http {
    error_log /var/log/nginx/error.log info;

    # Custom Log Format for Tracing and Observability
    log_format proxy_custom '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            'org_id:"$jwt_org_id" user_id:"$jwt_user_id" rid:"$request_id" '
                            'svc:"$service" upstream:"$upstream_addr" '
                            'urt:"$upstream_response_time" rt:"$request_time"';

    access_log /var/log/nginx/access.log proxy_custom;

    # NJS Integration
    js_path "/etc/nginx/njs/";
    js_import jwt from jwt.js;
    js_import metrics from metrics.js;
    
    # These variables execute the logic in your jwt.js
    js_set $jwt_org_id jwt.get_org_id;
    js_set $jwt_user_id jwt.get_user_id;

    # General Settings
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    # Docker DNS Resolver
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Global Proxy Settings (Inherited by all locations)
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID      $request_id;
    proxy_set_header Authorization     $http_authorization;
    
    # Injecting the identity context extracted from JWT
    proxy_set_header x-org-id          $jwt_org_id;
    proxy_set_header x-user-id         $jwt_user_id;
    proxy_set_header x-request-id      $request_id;

    # 1. HTTP to HTTPS Redirect
    server {
        listen 8080;
        server_name localhost;
        return 301 https://$host:8443$request_uri;
    }

    # 2. Main HTTPS Gateway
    server {
        listen 8443 ssl;
        server_name localhost;

        ssl_certificate      /etc/nginx/certs/nginx.crt;
        ssl_certificate_key  /etc/nginx/certs/nginx.key;

        # SSL Security Hardening
        ssl_protocols               TLSv1.3 TLSv1.2;
        ssl_ciphers                 ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers   off;

        # Security Headers
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Request-ID $request_id always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # ========================================
        # Pipeline Service API Routes
        # (consolidated: get-pipeline + list-pipelines + create-pipeline → pipeline-service)
        # ========================================
        # NOTE: Order matters! More specific routes BEFORE regex routes

        # Pipeline base route - POST creates, GET finds by filter
        location = /api/pipeline {
            set $service "pipeline";
            
            # POST -> pipeline-service POST /pipelines
            if ($request_method = POST) {
                rewrite ^/api/pipeline$ /pipelines break;
                proxy_pass http://pipeline:3000;
            }
            
            # GET -> pipeline-service GET /pipelines/find (with query filters)
            rewrite ^/api/pipeline$ /pipelines/find break;
            proxy_pass http://pipeline:3000;
        }

        # List pipelines route
        location = /api/pipelines {
            set $service "pipeline";
            rewrite ^/api/pipelines$ /pipelines break;
            proxy_pass http://pipeline:3000;
        }

        # Pipeline by ID (regex - matches /api/pipeline/:id) — GET or PUT
        location ~ ^/api/pipeline/([^/]+)$ {
            set $service "pipeline";
            rewrite ^/api/pipeline/(.+)$ /pipelines/$1 break;
            proxy_pass http://pipeline:3000;
        }

        # ========================================
        # Plugin Service API Routes
        # (consolidated: get-plugin + list-plugins + upload-plugin → plugin-service)
        # ========================================
        # NOTE: Order matters! /api/plugin/upload BEFORE /api/plugin

        # Upload plugin (POST to /api/plugin/upload)
        location = /api/plugin/upload {
            set $service "plugin";
            client_max_body_size 100m;
            
            # Increase timeouts for long-running upload/build operations (15 minutes)
            proxy_connect_timeout 60s;
            proxy_send_timeout 900s;
            proxy_read_timeout 900s;
            send_timeout 900s;
            
            rewrite ^/api/plugin/upload$ /plugins break;
            proxy_pass http://plugin:3000;
        }

        # Plugin base route - GET with filters
        location = /api/plugin {
            set $service "plugin";
            rewrite ^/api/plugin$ /plugins/find break;
            proxy_pass http://plugin:3000;
        }

        # List plugins route
        location = /api/plugins {
            set $service "plugin";
            rewrite ^/api/plugins$ /plugins break;
            proxy_pass http://plugin:3000;
        }

        # Plugin by ID (regex - matches /api/plugin/:id but NOT /api/plugin/upload) — GET or PUT
        location ~ ^/api/plugin/([^/]+)$ {
            set $service "plugin";
            rewrite ^/api/plugin/(.+)$ /plugins/$1 break;
            proxy_pass http://plugin:3000;
        }

        # ========================================
        # Quota Service API Routes
        # ========================================
        # NOTE: Order matters! More specific routes BEFORE regex routes

        # Quota base route - GET quota for requesting org
        location = /api/quota {
            set $service "quota";
            rewrite ^/api/quota$ /quotas break;
            proxy_pass http://quota:3000;
        }

        # Reset quota usage - POST /api/quota/:orgId/reset
        location ~ ^/api/quota/([^/]+)/reset$ {
            set $service "quota";
            rewrite ^/api/quota/([^/]+)/reset$ /quotas/$1/reset break;
            proxy_pass http://quota:3000;
        }

        # Increment quota usage - POST /api/quota/:orgId/increment
        location ~ ^/api/quota/([^/]+)/increment$ {
            set $service "quota";
            rewrite ^/api/quota/([^/]+)/increment$ /quotas/$1/increment break;
            proxy_pass http://quota:3000;
        }

        # Quota by org and type - GET /api/quota/:orgId/:quotaType
        location ~ ^/api/quota/([^/]+)/([^/]+)$ {
            set $service "quota";
            rewrite ^/api/quota/([^/]+)/([^/]+)$ /quotas/$1/$2 break;
            proxy_pass http://quota:3000;
        }

        # Quota by org - GET or PUT /api/quota/:orgId
        location ~ ^/api/quota/([^/]+)$ {
            set $service "quota";
            
            # PUT -> quota-service PUT /quotas/:orgId
            if ($request_method = PUT) {
                rewrite ^/api/quota/([^/]+)$ /quotas/$1 break;
                proxy_pass http://quota:3000;
            }
            
            # GET -> quota-service GET /quotas/:orgId
            rewrite ^/api/quota/([^/]+)$ /quotas/$1 break;
            proxy_pass http://quota:3000;
        }

        # ========================================
        # Platform API Routes
        # ========================================
        
        # Auth routes (login, register, refresh, logout)
        location /api/auth/ {
            set $service "auth";
            proxy_pass http://platform:3000/auth/;
        }

        # Current user routes (profile, change-password, etc.)
        location /api/user/ {
            set $service "user";
            proxy_pass http://platform:3000/user/;
        }

        # User management routes (admin - list, get, update, delete users)
        location /api/users {
            set $service "users";
            proxy_pass http://platform:3000/users;
        }

        # List all organizations (system admin only)
        location = /api/organizations {
            set $service "organizations";
            proxy_pass http://platform:3000/organizations;
        }

        # Organization management routes
        location /api/organization/ {
            set $service "organization";
            proxy_pass http://platform:3000/organization/;
        }

        # Invitation routes (send, accept, revoke invitations)
        location /api/invitation/ {
            set $service "invitation";
            proxy_pass http://platform:3000/invitation/;
        }

        # Invitation base route (list invitations)
        location = /api/invitation {
            set $service "invitation";
            proxy_pass http://platform:3000/invitation;
        }

        # ========================================
        # Health & Metrics
        # ========================================

        location /health {
            set $service "health";
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"status":"ok","timestamp":"$time_iso8601"}';
        }

        location /metrics {
            set $service "metrics";
            access_log off;
            js_content metrics.get_metrics;
        }

        location /metrics/services {
            set $service "service-metrics";
            access_log off;
            js_content metrics.service_metrics;
        }

        # ========================================
        # Infrastructure Services
        # ========================================
        
        location /registry/ {
            set $service "registry";
            client_max_body_size 0;
            proxy_pass http://registry:5000/;
        }
        
        location /pgadmin/ {
            set $service "pgadmin";
            proxy_http_version 1.1;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /pgadmin;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";           
            proxy_pass http://pgadmin:80;
            proxy_redirect off;
            proxy_buffering off;
        }

        location /mongo-express/ {
            set $service "mongo-express";
            proxy_pass http://mongo-express:8081;
        }

        location /registry-express/ {
            set $service "registry-express";
            proxy_pass http://registry-express:80/;
        }

        # ========================================
        # Frontend (Next.js)
        # ========================================
        
        # Next.js static files
        location /_next/ {
            set $service "frontend";
            proxy_pass http://frontend:3000;
            proxy_cache_valid 200 60m;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # Next.js public assets
        location /public/ {
            set $service "frontend";
            proxy_pass http://frontend:3000;
            proxy_cache_valid 200 60m;
        }

        # Frontend routes - must be last (catch-all)
        location / {
            set $service "frontend";
            proxy_pass http://frontend:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # ========================================
        # Error Handling
        # ========================================
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
