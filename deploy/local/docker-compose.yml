# =============================================================================
# Shared YAML Anchors
# =============================================================================

# -- Service defaults for API containers --
x-api-defaults:
  restart: always
  networks: &api-networks
    - backend-network
  healthcheck: &api-healthcheck
    test:
      - CMD
      - curl
      - '-f'
      - 'http://localhost:3000/health'
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 60s
  deploy: &api-deploy
    resources:
      limits:
        cpus: '0.75'
        memory: 768M
      reservations:
        cpus: '0.4'
        memory: 384M

# -- Env shared by ALL api services (platform, plugin, pipeline, quota) --
x-common-env: &common-env
  LOG_LEVEL: '${LOG_LEVEL:-info}'
  JWT_SECRET: '${JWT_SECRET}'
  PLATFORM_BASE_URL: '${PLATFORM_BASE_URL:-https://localhost:8443}'

# -- Env shared by Postgres-backed services (platform, plugin, pipeline) --
x-postgres-env: &postgres-env
  DB_HOST: '${DB_HOST}'
  DB_PORT: '${DB_PORT}'
  DATABASE: '${DATABASE}'
  DB_USER: '${DB_USER}'
  DB_PASSWORD: '${DB_PASSWORD}'
  DRIZZLE_MAX_POOL_SIZE: '${DRIZZLE_MAX_POOL_SIZE:-20}'
  DRIZZLE_IDLE_TIMEOUT_MILLIS: '${DRIZZLE_IDLE_TIMEOUT_MILLIS:-30000}'
  DRIZZLE_CONNECTION_TIMEOUT_MILLIS: '${DRIZZLE_CONNECTION_TIMEOUT_MILLIS:-10000}'
  REFRESH_TOKEN_SECRET: '${REFRESH_TOKEN_SECRET}'

# -- Env shared by Express server services (platform, plugin, pipeline) --
x-server-env: &server-env
  CORS_CREDENTIALS: '${CORS_CREDENTIALS:-true}'
  CORS_ORIGIN: '${CORS_ORIGIN}'
  LIMITER_MAX: '${LIMITER_MAX:-100}'
  LIMITER_WINDOWMS: '${LIMITER_WINDOWMS:-900000}'

# -- Env for services that call the quota service --
x-quota-client-env: &quota-client-env
  QUOTA_SERVICE_HOST: '${QUOTA_SERVICE_HOST:-quota}'
  QUOTA_SERVICE_PORT: '${QUOTA_SERVICE_PORT:-3000}'

# =============================================================================
# Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # Infrastructure
  # ---------------------------------------------------------------------------
  nginx:
    image: 'nginx:latest'
    container_name: nginx
    ports:
      - '8080:8080'
      - '8443:8443'
    restart: always
    environment:
      JWT_SECRET: '${JWT_SECRET}'
    volumes:
      - './certs/nginx.crt:/etc/nginx/certs/nginx.crt:ro'
      - './certs/nginx.key:/etc/nginx/certs/nginx.key:ro'
      - './nginx/nginx.conf:/etc/nginx/nginx.conf:ro'
      - './nginx/jwt.js:/etc/nginx/njs/jwt.js:ro'
      - './nginx/metrics.js:/etc/nginx/njs/metrics.js:ro'
    networks:
      - proxy-network
      - backend-network
    depends_on:
      platform:
        condition: service_healthy
      frontend:
        condition: service_healthy
      plugin:
        condition: service_healthy
      pipeline:
        condition: service_healthy
      quota:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.2'
          memory: 128M

  # ---------------------------------------------------------------------------
  # Databases
  # ---------------------------------------------------------------------------
  mongodb:
    image: 'mongo:latest'
    container_name: mongodb
    command:
      - mongod
      - '--bind_ip_all'
      - '--replSet'
      - rs0
      - '--keyFile'
      - /etc/mongodb-keyfile
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: '${MONGO_INITDB_ROOT_USERNAME}'
      MONGO_INITDB_ROOT_PASSWORD: '${MONGO_INITDB_ROOT_PASSWORD}'
      MONGO_INITDB_DATABASE: platform
    healthcheck:
      test: >
        bash -c 'mongosh --quiet --host localhost:27017 --username
        ${MONGO_INITDB_ROOT_USERNAME} --password ${MONGO_INITDB_ROOT_PASSWORD}
        --authenticationDatabase admin --eval
        "db.getSiblingDB(\"admin\").runCommand({ replSetGetStatus: 1 }).ok" ||
        (mongosh --quiet --host localhost:27017 --username
        ${MONGO_INITDB_ROOT_USERNAME} --password ${MONGO_INITDB_ROOT_PASSWORD}
        --authenticationDatabase admin --eval "rs.initiate({ _id: \"rs0\",
        members: [{ _id: 0, host: \"mongodb:27017\" }] })" && exit 1)'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - './db-data/mongodb/:/data/db/:rw'
      - './mongodb-keyfile:/etc/mongodb-keyfile:ro'
      - './mongodb-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro'
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.8'
          memory: 768M

  postgres:
    image: 'postgres:latest'
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'
    command: postgres -c listen_addresses=*
    healthcheck:
      test:
        - CMD
        - pg_isready
        - '-U'
        - '${POSTGRES_USER}'
        - '-d'
        - '${POSTGRES_DB}'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - './db-data/postgres/:/var/lib/postgresql/:rw'
      - './postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro'
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.8'
          memory: 768M

  # ---------------------------------------------------------------------------
  # Admin UIs
  # ---------------------------------------------------------------------------
  mongo-express:
    image: 'mongo-express:latest'
    container_name: mongo-express
    restart: always
    ports:
      - '27081:8081'
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      ME_CONFIG_MONGODB_URL: '${ME_CONFIG_MONGODB_URL}'
      ME_CONFIG_SITE_BASEURL: '${ME_CONFIG_SITE_BASEURL}'
      ME_CONFIG_MONGODB_ENABLE_ADMIN: '${ME_CONFIG_MONGODB_ENABLE_ADMIN}'
      ME_CONFIG_MONGODB_ADMINUSERNAME: '${ME_CONFIG_MONGODB_ADMINUSERNAME}'
      ME_CONFIG_MONGODB_ADMINPASSWORD: '${ME_CONFIG_MONGODB_ADMINPASSWORD}'
      ME_CONFIG_BASICAUTH_USERNAME: '${ME_CONFIG_BASICAUTH_USERNAME}'
      ME_CONFIG_BASICAUTH_PASSWORD: '${ME_CONFIG_BASICAUTH_PASSWORD}'
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 192M

  pgadmin:
    image: 'dpage/pgadmin4:latest'
    container_name: pgadmin
    restart: always
    ports:
      - '5480:80'
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: '${PGADMIN_DEFAULT_EMAIL}'
      PGADMIN_DEFAULT_PASSWORD: '${PGADMIN_DEFAULT_PASSWORD}'
    volumes:
      - './pgadmin-data/:/var/lib/pgadmin/:rw'
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M

  # ---------------------------------------------------------------------------
  # Docker Registry
  # ---------------------------------------------------------------------------
  registry:
    image: 'registry:latest'
    container_name: registry
    restart: always
    ports:
      - '5000:5000'
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_HTTP_ADDR: '0.0.0.0:5000'
      REGISTRY_HTTP_TLS_KEY: /etc/ssl/private/registry.key
      REGISTRY_HTTP_TLS_CERTIFICATE: /etc/ssl/certs/registry.crt
      REGISTRY_AUTH_HTPASSWD_REALM: registry realm
      REGISTRY_AUTH_HTPASSWD_PATH: /etc/auth/registry.passwd
      REGISTRY_STORAGE_DELETE_ENABLED: 'true'
    volumes:
      - './auth/registry.passwd:/etc/auth/registry.passwd:ro'
      - './certs/registry.crt:/etc/ssl/certs/registry.crt:ro'
      - './certs/registry.key:/etc/ssl/private/registry.key:ro'
      - './registry-data/:/var/lib/registry/:rw'
    networks:
      - proxy-network
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.6'
          memory: 512M
        reservations:
          cpus: '0.3'
          memory: 256M

  registry-express:
    image: 'joxit/docker-registry-ui:latest'
    container_name: registry-express
    restart: always
    ports:
      - '5080:80'
    environment:
      REGISTRY_TITLE: '${JOXIT_REGISTRY_TITLE}'
      NGINX_PROXY_PASS_URL: '${JOXIT_NGINX_PROXY_PASS_URL}'
      SINGLE_REGISTRY: '${JOXIT_SINGLE_REGISTRY}'
      ENABLE_DELETE_IMAGES: '${JOXIT_ENABLE_DELETE_IMAGES}'
      SHOW_CONTENT_DIGEST: '${JOXIT_SHOW_CONTENT_DIGEST}'
    depends_on:
      - registry
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 192M

  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------
  frontend:
    image: 'ghcr.io/mwashburn160/frontend:1.9.13'
    container_name: frontend
    restart: always
    networks:
      - proxy-network
    environment:
      PLATFORM_BASE_URL: '${PLATFORM_BASE_URL}'
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - >-
          require('http').get('http://localhost:3000/', (r) =>
          process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () =>
          process.exit(1))
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  platform:
    restart: always
    networks: *api-networks
    healthcheck: *api-healthcheck
    deploy: *api-deploy
    image: 'ghcr.io/mwashburn160/platform:1.10.13'
    container_name: platform
    depends_on:
      mongodb:
        condition: service_healthy
      plugin:
        condition: service_healthy
      pipeline:
        condition: service_healthy
      quota:
        condition: service_healthy
    environment:
      <<: [*common-env, *postgres-env, *server-env, *quota-client-env]
      # JWT
      JWT_EXPIRES_IN: '${JWT_EXPIRES_IN}'
      JWT_ALGORITHM: '${JWT_ALGORITHM:-HS256}'
      JWT_SALT_ROUNDS: '${JWT_SALT_ROUNDS}'
      REFRESH_TOKEN_EXPIRES_IN: '${REFRESH_TOKEN_EXPIRES_IN}'
      # Platform
      PLATFORM_FRONTEND_URL: '${PLATFORM_FRONTEND_URL:-https://localhost:8443}'
      TRUST_PROXY: '${TRUST_PROXY}'
      # MongoDB
      MONGODB_URI: '${MONGODB_URI}'
      # Email
      EMAIL_ENABLED: '${EMAIL_ENABLED}'
      EMAIL_FROM: '${EMAIL_FROM}'
      EMAIL_FROM_NAME: '${EMAIL_FROM_NAME}'
      EMAIL_PROVIDER: '${EMAIL_PROVIDER:-smtp}'
      SMTP_HOST: '${SMTP_HOST}'
      SMTP_PORT: '${SMTP_PORT}'
      SMTP_SECURE: '${SMTP_SECURE}'
      SMTP_USER: '${SMTP_USER}'
      SMTP_PASS: '${SMTP_PASS}'
      SES_REGION: '${SES_REGION:-us-east-1}'
      SES_ACCESS_KEY_ID: '${SES_ACCESS_KEY_ID}'
      SES_SECRET_ACCESS_KEY: '${SES_SECRET_ACCESS_KEY}'
      AWS_REGION: '${AWS_REGION:-us-east-1}'
      # Invitations
      INVITATION_EXPIRATION_DAYS: '${INVITATION_EXPIRATION_DAYS}'
      INVITATION_MAX_PENDING_PER_ORG: '${INVITATION_MAX_PENDING_PER_ORG}'
      # OAuth
      OAUTH_GOOGLE_CLIENT_ID: '${OAUTH_GOOGLE_CLIENT_ID}'
      OAUTH_GOOGLE_CLIENT_SECRET: '${OAUTH_GOOGLE_CLIENT_SECRET}'
      OAUTH_CALLBACK_BASE_URL: '${OAUTH_CALLBACK_BASE_URL:-https://localhost:8443}'
      # Service URLs
      LIST_PLUGINS_URL: '${LIST_PLUGINS_URL:-https://localhost:8443}'
      GET_PLUGIN_URL: '${GET_PLUGIN_URL:-https://localhost:8443}'
      UPLOAD_PLUGIN_URL: '${UPLOAD_PLUGIN_URL:-https://localhost:8443}'
      LIST_PIPELINES_URL: '${LIST_PIPELINES_URL:-https://localhost:8443}'
      GET_PIPELINE_URL: '${GET_PIPELINE_URL:-https://localhost:8443}'
      CREATE_PIPELINE_URL: '${CREATE_PIPELINE_URL:-https://localhost:8443}'
      SERVICE_TIMEOUT: '${SERVICE_TIMEOUT:-30000}'
      # Quotas
      QUOTA_BYPASS_ORG_ID: '${QUOTA_BYPASS_ORG_ID:-system}'
      QUOTA_DEFAULT_WINDOW_MS: '${QUOTA_DEFAULT_WINDOW_MS:-60000}'
      QUOTA_ORG_PLUGINS_DEFAULT: '${QUOTA_ORG_PLUGINS_DEFAULT:-100}'
      QUOTA_ORG_PIPELINES_DEFAULT: '${QUOTA_ORG_PIPELINES_DEFAULT:-50}'
      QUOTA_ORG_API_CALLS_DEFAULT: '${QUOTA_ORG_API_CALLS_DEFAULT:-10000}'
      QUOTA_RESET_PERIOD_PLUGINS: '${QUOTA_RESET_PERIOD_PLUGINS:-3days}'
      QUOTA_RESET_PERIOD_PIPELINES: '${QUOTA_RESET_PERIOD_PIPELINES:-3days}'
      QUOTA_RESET_PERIOD_API_CALLS: '${QUOTA_RESET_PERIOD_API_CALLS:-3days}'
      QUOTA_CREATE_PLUGIN_LIMIT: '${QUOTA_CREATE_PLUGIN_LIMIT:-unlimited}'
      QUOTA_CREATE_PLUGIN_WINDOW_MS: '${QUOTA_CREATE_PLUGIN_WINDOW_MS:-60000}'
      QUOTA_GET_PLUGIN_LIMIT: '${QUOTA_GET_PLUGIN_LIMIT:-10}'
      QUOTA_GET_PLUGIN_WINDOW_MS: '${QUOTA_GET_PLUGIN_WINDOW_MS:-60000}'
      QUOTA_CREATE_PIPELINE_LIMIT: '${QUOTA_CREATE_PIPELINE_LIMIT:-unlimited}'
      QUOTA_CREATE_PIPELINE_WINDOW_MS: '${QUOTA_CREATE_PIPELINE_WINDOW_MS:-60000}'
      QUOTA_GET_PIPELINE_LIMIT: '${QUOTA_GET_PIPELINE_LIMIT:-10}'
      QUOTA_GET_PIPELINE_WINDOW_MS: '${QUOTA_GET_PIPELINE_WINDOW_MS:-60000}'

  plugin:
    restart: always
    networks: *api-networks
    healthcheck: *api-healthcheck
    deploy: *api-deploy
    image: 'ghcr.io/mwashburn160/plugin:1.8.12'
    container_name: plugin
    depends_on:
      postgres:
        condition: service_healthy
      quota:
        condition: service_healthy
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
    group_add:
      - '${DOCKER_GID:-999}'
    environment:
      <<: [*common-env, *postgres-env, *server-env, *quota-client-env]
      SERVICE_NAME: plugin
      # Docker registry
      IMAGE_REGISTRY_HOST: '${IMAGE_REGISTRY_HOST:-registry}'
      IMAGE_REGISTRY_PORT: '${IMAGE_REGISTRY_PORT:-5000}'
      IMAGE_REGISTRY_USER: '${IMAGE_REGISTRY_USER:-admin}'
      IMAGE_REGISTRY_TOKEN: '${IMAGE_REGISTRY_TOKEN}'
      DOCKER_NETWORK: '${DOCKER_NETWORK:-backend-network}'

  pipeline:
    restart: always
    networks: *api-networks
    healthcheck: *api-healthcheck
    deploy: *api-deploy
    image: 'ghcr.io/mwashburn160/pipeline:1.8.12'
    container_name: pipeline
    depends_on:
      postgres:
        condition: service_healthy
      quota:
        condition: service_healthy
    environment:
      <<: [*common-env, *postgres-env, *server-env, *quota-client-env]
      SERVICE_NAME: pipeline
      HANDLER_TIMEOUT_MS: '${HANDLER_TIMEOUT_MS:-30000}'

  quota:
    restart: always
    networks: *api-networks
    healthcheck: *api-healthcheck
    deploy: *api-deploy
    image: 'ghcr.io/mwashburn160/quota:1.8.12'
    container_name: quota
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      <<: *common-env
      SERVICE_NAME: quota
      REFRESH_TOKEN_SECRET: '${REFRESH_TOKEN_SECRET}'
      PORT: '${PORT:-3000}'
      MONGODB_URI: '${MONGODB_URI}'
      RATE_LIMIT_WINDOW_MS: '${RATE_LIMIT_WINDOW_MS:-60000}'
      RATE_LIMIT_MAX: '${RATE_LIMIT_MAX:-100}'
      QUOTA_DEFAULT_PLUGINS: '${QUOTA_DEFAULT_PLUGINS:-100}'
      QUOTA_DEFAULT_PIPELINES: '${QUOTA_DEFAULT_PIPELINES:-50}'
      QUOTA_DEFAULT_API_CALLS: '${QUOTA_DEFAULT_API_CALLS:-10000}'
      QUOTA_RESET_DAYS: '${QUOTA_RESET_DAYS:-3}'

# =============================================================================
# Networks
# =============================================================================
networks:
  proxy-network:
    name: proxy-network
  backend-network:
    name: backend-network
    driver: bridge
