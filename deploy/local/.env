# ============================================================================
# Pipeline Manager - Environment Configuration
# ============================================================================
# Copy this file to .env and update with your actual values
# IMPORTANT: Never commit .env file to version control!
# Add .env to .gitignore
# ============================================================================

# ============================================================================
# Platform Configuration
# ============================================================================

# Platform URL - Used by services to reference the API gateway
# Used by CLI when PLATFORM_BASE_URL environment variable is not set
PLATFORM_BASE_URL=https://localhost:8443

# Frontend URL - Used for email links, OAuth redirects, etc.
PLATFORM_FRONTEND_URL=https://localhost:8443

# Service port (used by platform, quota, pipeline-core)
PORT=3000

# Trust proxy headers (for production behind load balancer)
# Set to 1 if behind nginx, ALB, etc.
TRUST_PROXY=1

# ============================================================================
# Logging Configuration
# ============================================================================

# Log level (error | warn | info | debug)
LOG_LEVEL=info

# Service name used in log output
SERVICE_NAME=api

# ============================================================================
# CORS Configuration
# ============================================================================

# Allow credentials in CORS requests (true | false)
CORS_CREDENTIALS=true

# Allowed CORS origins (comma-separated, leave empty for default)
# Example: https://localhost:3000,https://app.example.com
CORS_ORIGIN=

# ============================================================================
# JWT Configuration (REQUIRED)
# ============================================================================

# JWT Secret - Used to sign and verify PLATFORM_TOKEN
# SECURITY: Generate a strong random secret (32+ characters)
# Example: openssl rand -base64 32
JWT_SECRET=1EXFSnwcl8TyeaDMBHFneIxnccCoxixuvfZlsd5+cJM=

# JWT Token expiration (in seconds)
# 900 = 15 minutes, 3600 = 1 hour, 86400 = 24 hours
JWT_EXPIRES_IN=86400

# JWT signing algorithm (HS256 | HS384 | HS512 | RS256)
JWT_ALGORITHM=HS256

# JWT Salt rounds for bcrypt
# Higher = more secure but slower (10-12 recommended)
JWT_SALT_ROUNDS=12

# Refresh Token Secret - Separate secret for refresh tokens
# SECURITY: Generate a different secret from JWT_SECRET
REFRESH_TOKEN_SECRET=LA2eRmPbq9Oy+ZWNTi7FVaWCVPK4gzXFkfpjGivmpug=

# Refresh Token expiration (in seconds)
# 2592000 = 30 days
REFRESH_TOKEN_EXPIRES_IN=2592000

# ============================================================================
# Security Configuration
# ============================================================================

# Minimum password length
MIN_PASSWORD_LENGTH=12

# Maximum login attempts before lockout
MAX_LOGIN_ATTEMPTS=5

# ============================================================================
# Google OAuth Configuration (Optional)
# ============================================================================
# Enables "Continue with Google" on login/register pages.
# Create credentials at: https://console.cloud.google.com/apis/credentials
# Authorized redirect URI: ${PLATFORM_FRONTEND_URL}/auth/callback/google

# Google OAuth Client ID (leave empty to disable)
OAUTH_GOOGLE_CLIENT_ID=
OAUTH_GOOGLE_CLIENT_SECRET=

# OAuth callback base URL (defaults to PLATFORM_FRONTEND_URL if not set)
# Only override if your frontend URL differs from the OAuth redirect origin
OAUTH_CALLBACK_BASE_URL=${PLATFORM_FRONTEND_URL}

# ============================================================================
# Organization Quota Defaults (Quota Service)
# ============================================================================
# Default limits applied to new organizations
# Used by: quota service
# System admins can override these per-organization

# Maximum plugins per organization
QUOTA_DEFAULT_PLUGINS=100

# Maximum pipelines per organization
QUOTA_DEFAULT_PIPELINES=50

# Maximum API calls per organization (per reset period)
QUOTA_DEFAULT_API_CALLS=10000

# Quota reset period in days
# Usage counters reset after this many days
QUOTA_RESET_DAYS=3

# ============================================================================
# Organization Quota Defaults (Platform)
# ============================================================================
# Default org-level quota limits used by the platform service

# Organization plugin limit
QUOTA_ORG_PLUGINS_DEFAULT=100

# Organization pipeline limit
QUOTA_ORG_PIPELINES_DEFAULT=50

# Organization API calls limit
QUOTA_ORG_API_CALLS_DEFAULT=10000

# Quota reset periods (format: <number>days, e.g. 3days)
QUOTA_RESET_PERIOD_PLUGINS=3days
QUOTA_RESET_PERIOD_PIPELINES=3days
QUOTA_RESET_PERIOD_API_CALLS=3days

# ============================================================================
# Quota Service Configuration
# ============================================================================
# Internal service discovery for quota enforcement
# Used by: plugin, pipeline services

# Quota service hostname (Docker service name)
QUOTA_SERVICE_HOST=quota

# Quota service port
QUOTA_SERVICE_PORT=3000

# ============================================================================
# Rate Limiting Configuration
# ============================================================================
# Per-organization rate limits for API operations
# Set to 'unlimited' to disable rate limiting for an operation

# Organization ID that bypasses all quotas (typically 'system')
QUOTA_BYPASS_ORG_ID=system

# Default rate limit window in milliseconds (60000 = 60 seconds)
QUOTA_DEFAULT_WINDOW_MS=60000

# Quota service rate limiting
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX=100

# Plugin rate limits
# Create plugin: requests per window (set to 'unlimited' for no limit)
QUOTA_CREATE_PLUGIN_LIMIT=unlimited
QUOTA_CREATE_PLUGIN_WINDOW_MS=60000

# Get plugin by ID: requests per window
QUOTA_GET_PLUGIN_LIMIT=10
QUOTA_GET_PLUGIN_WINDOW_MS=60000

# Pipeline rate limits
# Create pipeline: requests per window (set to 'unlimited' for no limit)
QUOTA_CREATE_PIPELINE_LIMIT=unlimited
QUOTA_CREATE_PIPELINE_WINDOW_MS=60000

# Get pipeline by ID: requests per window
QUOTA_GET_PIPELINE_LIMIT=10
QUOTA_GET_PIPELINE_WINDOW_MS=60000

# ============================================================================
# Global Rate Limiting
# ============================================================================
# Applied to all API requests (independent of quota middleware)

# Maximum requests per window
LIMITER_MAX=100

# Rate limit window in milliseconds (900000 = 15 minutes)
LIMITER_WINDOWMS=900000

# ============================================================================
# Email Configuration
# ============================================================================

# Enable/disable email sending
EMAIL_ENABLED=false

# Sender information
EMAIL_FROM=noreply@example.com
EMAIL_FROM_NAME=Platform

# Email provider (smtp | ses)
EMAIL_PROVIDER=smtp

# SMTP Configuration
SMTP_HOST=localhost
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=
SMTP_PASS=

# AWS SES Configuration (used when EMAIL_PROVIDER=ses)
SES_REGION=us-east-1
SES_ACCESS_KEY_ID=
SES_SECRET_ACCESS_KEY=
AWS_REGION=us-east-1

# ============================================================================
# Invitation Configuration
# ============================================================================

# Invitation expiration (in days)
INVITATION_EXPIRATION_DAYS=7

# Maximum pending invitations per organization
INVITATION_MAX_PENDING_PER_ORG=50

# ============================================================================
# PostgreSQL Database Configuration
# ============================================================================

# PostgreSQL connection details
# Used by: postgres container, pipeline, plugin services
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
POSTGRES_DB=pipeline_builder

# Database connection for services (should match POSTGRES_* values)
DB_HOST=postgres
DB_PORT=5432
DATABASE=pipeline_builder
DB_USER=postgres
DB_PASSWORD=password

# Drizzle ORM Configuration
DRIZZLE_MAX_POOL_SIZE=20
DRIZZLE_IDLE_TIMEOUT_MILLIS=30000
DRIZZLE_CONNECTION_TIMEOUT_MILLIS=10000

# ============================================================================
# MongoDB Configuration
# ============================================================================

# MongoDB Admin Credentials
# Used by: platform, quota services
MONGO_INITDB_ROOT_USERNAME=mongo
MONGO_INITDB_ROOT_PASSWORD=password
MONGO_INITDB_DATABASE=platform

# MongoDB Connection URI (Replica Set)
# Format: mongodb://username:password@host:port/database?options
# Used by: platform, quota services
MONGODB_URI=mongodb://mongo:password@mongodb:27017/platform?replicaSet=rs0&authSource=admin

# ============================================================================
# Mongo Express (MongoDB Admin UI)
# ============================================================================

# Mongo Express Configuration
# Access at: http://localhost:27081 or https://localhost:8443/mongo-express/
ME_CONFIG_SITE_BASEURL=/mongo-express/
ME_CONFIG_MONGODB_URL=mongodb://mongo:password@mongodb:27017/platform?replicaSet=rs0&authSource=admin
ME_CONFIG_MONGODB_ENABLE_ADMIN=true
ME_CONFIG_MONGODB_ADMINUSERNAME=mongo
ME_CONFIG_MONGODB_ADMINPASSWORD=password

# Mongo Express Web Authentication
ME_CONFIG_BASICAUTH_USERNAME=admin
ME_CONFIG_BASICAUTH_PASSWORD=password

# ============================================================================
# PgAdmin (PostgreSQL Admin UI)
# ============================================================================

# PgAdmin Configuration
# Access at: http://localhost:5480 or https://localhost:8443/pgadmin/
PGADMIN_DEFAULT_EMAIL=mwashburn160@gmail.com
PGADMIN_DEFAULT_PASSWORD=password

# ============================================================================
# Docker Registry Configuration
# ============================================================================

# Docker Registry for Plugin Images
# Used by: plugin service
IMAGE_REGISTRY_HOST=registry
IMAGE_REGISTRY_PORT=5000
IMAGE_REGISTRY_USER=admin
IMAGE_REGISTRY_TOKEN=password

# Docker socket GID — the plugin service mounts /var/run/docker.sock
# to build plugin images. Set this to the GID of the docker group on
# your host: run `stat -f '%g' /var/run/docker.sock` (macOS)
# or `stat -c '%g' /var/run/docker.sock` (Linux)
DOCKER_GID=0

# Docker network for plugin builds — the compose network where the
# registry service is reachable. Typically <project>_backend-network.
# Run `docker network ls` to find the correct name.
DOCKER_NETWORK=backend-network

# ============================================================================
# Registry UI (Docker Registry Web Interface)
# ============================================================================

# Joxit Docker Registry UI Configuration
# Access at: http://localhost:5080 or https://localhost:8443/registry-express/
JOXIT_REGISTRY_TITLE=Pipeline Builder Registry
JOXIT_NGINX_PROXY_PASS_URL=https://registry:5000
JOXIT_SINGLE_REGISTRY=true
JOXIT_ENABLE_DELETE_IMAGES=true
JOXIT_SHOW_CONTENT_DIGEST=true

# ============================================================================
# Internal Service URLs (Platform Service Discovery)
# ============================================================================
# URLs used by the platform service to route to microservices
# In Docker Compose these typically point to the gateway

LIST_PLUGINS_URL=https://localhost:8443
GET_PLUGIN_URL=https://localhost:8443
UPLOAD_PLUGIN_URL=https://localhost:8443
LIST_PIPELINES_URL=https://localhost:8443
GET_PIPELINE_URL=https://localhost:8443
CREATE_PIPELINE_URL=https://localhost:8443

# Internal service HTTP timeout (milliseconds)
SERVICE_TIMEOUT=30000

# Handler timeout for pipeline-core (milliseconds)
HANDLER_TIMEOUT_MS=30000

# ============================================================================
# AWS CDK / Lambda Configuration
# ============================================================================
# Used by pipeline-core for CDK infrastructure builds

# Lambda runtime version
LAMBDA_RUNTIME=nodejs22.x

# Lambda timeout in seconds (max 900 = 15 minutes)
LAMBDA_TIMEOUT=900

# Lambda memory size in MB
LAMBDA_MEMORY_SIZE=128

# Lambda architecture (ARM_64 | x86_64)
LAMBDA_ARCHITECTURE=ARM_64

# ============================================================================
# AWS CloudWatch / CodeBuild Configuration
# ============================================================================

# CloudWatch log group name
LOG_GROUP_NAME=/pipeline-builder/logs

# Log retention in days (1, 3, 5, 7, 14, 30, 60, 90, etc.)
LOG_RETENTION=1

# Log removal policy (DESTROY | RETAIN)
LOG_REMOVAL_POLICY=DESTROY

# CodeBuild compute type (SMALL | MEDIUM | LARGE | X2_LARGE)
CODEBUILD_COMPUTE_TYPE=SMALL
